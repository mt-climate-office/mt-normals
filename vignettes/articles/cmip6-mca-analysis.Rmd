---
title: "Rerunning the Montana Climate Assessment with CMIP6 Data"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = nzchar(Sys.getenv("CMIP6_DIR"))
)
```

```{r setup}
library(magrittr)
library(terra)
library(sf)
library(ggplot2)

data_dir <- Sys.getenv("CMIP6_DIR")
mt <- urbnmapr::get_urbn_map(sf = TRUE) %>% 
  dplyr::filter(state_abbv == "MT")
# reference_period <- c(1991, 2020)
# mid_century <- c(2040, 2069)
# end_century <- c(2070, 2099)
```

```{r to_shp} 
mco_mask <- function(rast, mask){
  raster::mask(rast,
               fasterize::fasterize(mask %>%
                                      sf::st_transform(raster::projection(rast)),
                                    raster::raster(rast))
  )
}

to_shp <- function(x) {
  x %>%
    terra::project(
     'PROJCS["NAD_1983_HARN_StatePlane_Montana_FIPS_2500 (deprecated)",
    GEOGCS["NAD83(HARN)",
        DATUM["NAD83_High_Accuracy_Reference_Network",
            SPHEROID["GRS 1980",6378137,298.257222101,
                AUTHORITY["EPSG","7019"]],
            AUTHORITY["EPSG","6152"]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4152"]],
    PROJECTION["Lambert_Conformal_Conic_2SP"],
    PARAMETER["latitude_of_origin",44.25],
    PARAMETER["central_meridian",-109.5],
    PARAMETER["standard_parallel_1",45],
    PARAMETER["standard_parallel_2",49],
    PARAMETER["false_easting",600000],
    PARAMETER["false_northing",0],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["Easting",EAST],
    AXIS["Northing",NORTH],
    AUTHORITY["ESRI","102300"]]'
    ) %>%
    terra::mask(mt %>% terra::vect(), touches=F) %>%
    raster::stack() %>%
    mco_mask(mask = mt) %>%
    spex::qm_rasterToPolygons(na.rm = T) 
}
```

```{r plot_seasonal} 
plot_seasonal <- function(dat, mt) {
  ggplot(dat) + 
    geom_sf(aes(fill = value), color = NA) + 
    facet_wrap(~season) + 
    geom_sf(data = mt, fill = NA) + 
    theme_bw()
}
```

```{r agg_func}
season_map <- function(x) {
  switch(
    x,
    {"Winter"},
    {"Spring"}, 
    {"Summer"}, 
    {"Fall"}
  )
}


ensemble_average <- function(fs, transform, fun="mean") {
  stk <- terra::rast(fs) %>% 
    terra::tapp(index="days", fun="mean")
  
  times <- tibble::tibble(
    date = names(stk) %>% 
      stringr::str_replace("X", "") %>% 
      lubridate::as_date()
  ) %>% 
    dplyr::mutate(
      season = dplyr::case_when(
        lubridate::month(date) %in% c(12, 1, 2) ~ 1, # 1=winter
        lubridate::month(date) %in% c(3, 4, 5) ~ 2, # 2=spring
        lubridate::month(date) %in% c(6, 7, 8) ~ 3, # 3=summer
        lubridate::month(date) %in% c(9, 10, 11) ~ 4 # 4=fall
      ), 
      idx = 1:dplyr::n()
    ) %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(
      year = ifelse(
        (season == 1) && (lubridate::month(date)) == 12, 
        lubridate::year(date) + 1,
        lubridate::year(date)
      )
    ) %>%
    dplyr::group_by(year, season) %>% 
    dplyr::mutate(
      yearly_grp = dplyr::cur_group_id(),
      group_count = dplyr::n()
    ) %>% 
    dplyr::filter(group_count == 3)
  
  times_by_season <- times %>% 
    dplyr::select(year, season, yearly_grp) %>% 
    dplyr::distinct()
  
  seasonal_by_year <- terra::subset(stk, times$idx) %>%
    terra::tapp(
      stk, 
      index = times$yearly_grp, 
      fun = fun
    ) %>% 
    terra::tapp(
      index = times_by_season$season,
      fun = "mean"
    )

      magrittr::set_names(c("Winter", "Spring", "Summer", "Fall")) %>% 
      to_shp() %>% 
      tidyr::pivot_longer(
        -geometry,
        names_to = "season", 
        values_to = "value"
      ) %>% 
      dplyr::mutate(value = transform(value))
}
```

```{r table2.1}
# This is originally a table, probably will now be a figure
# TODO: Choose range of years.

f_list <- file.path(data_dir, "nexgddp_cmip6", "monthly") %>% 
  list.files(full.names = T, pattern = "tas") %>% 
  grep(".json", ., value = T, invert = T) %>% 
  grep("historical", ., value = T)

tmp <- terra::rast(f_list[[1]])
mt <- sf::st_transform(mt, crs = sf::st_crs(tmp))
transform <- function(x) (x - 273.15) * 1.8 + 32

tmin <- grep("tasmin.tif", f_list, value = T) %>% ensemble_average(transform = transform)
tmax <- grep("tasmax", f_list, value = T) %>% ensemble_average(transform = transform)
tavg <- grep("tas.tif", f_list, value = T) %>% ensemble_average(transform = transform)
```
```{r table2.2}
fs <- file.path(data_dir, "nexgddp_cmip6", "monthly") %>% 
  list.files(full.names = T, pattern = "pr") %>% 
  grep(".json", ., value = T, invert = T) %>% 
  grep("historical", ., value = T)

tmp <- terra::rast(f_list[[1]])
mt <- sf::st_transform(mt, crs = sf::st_crs(tmp))


ppt <- ensemble_average(fs, transform = transform, fun = "sum")
```
