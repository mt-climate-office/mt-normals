---
title: "Rerunning the Montana Climate Assessment with CMIP6 Data"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = nzchar(Sys.getenv("CMIP6_DIR"))
)
```

```{r setup}
library(magrittr)
library(terra)
library(mcor)
library(sf)
library(ggplot2)

data_dir <- Sys.getenv("CMIP6_DIR")
mt <- mcor::mt_state_simple
# reference_period <- c(1991, 2020)
# mid_century <- c(2040, 2069)
# end_century <- c(2070, 2099)
```

```{r to_shp} 
to_shp <- function(x) {
  x %>%
    terra::project(
     mcor::mt_state_plane %>% as.character() %>% magrittr::extract(2)
    ) %>%
    terra::mask(mcor::mt_state %>% terra::vect(), touches=F) %>%
    raster::stack() %>%
    mcor::mco_mask(mask = mcor::mt_state) %>%
    spex::qm_rasterToPolygons(na.rm = T) 
}
```

```{r plot_seasonal} 
plot_seasonal <- function(dat, mt) {
  ggplot(dat) + 
    geom_sf(aes(fill = value), color = NA) + 
    facet_wrap(~season) + 
    geom_sf(data = mcor::mt_state_simple, fill = NA) + 
    theme_bw()
}
```

```{r agg_func}
season_map <- function(x) {
  switch(
    x,
    {"Winter"},
    {"Spring"}, 
    {"Summer"}, 
    {"Fall"}
  )
}


ensemble_average <- function(fs, transform, fun="mean") {
  stk <- terra::rast(fs) %>% 
    terra::tapp(index="days", fun=fun)
  
  times <- tibble::tibble(
    date = names(stk) %>% 
      stringr::str_replace("X", "") %>% 
      lubridate::as_date()
  ) %>% 
    dplyr::mutate(
      season = dplyr::case_when(
        lubridate::month(date) %in% c(12, 1, 2) ~ 1, # 1=winter
        lubridate::month(date) %in% c(3, 4, 5) ~ 2, # 2=spring
        lubridate::month(date) %in% c(6, 7, 8) ~ 3, # 3=summer
        lubridate::month(date) %in% c(9, 10, 11) ~ 4 # 4=fall
      ), 
      idx = 1:dplyr::n()
    )
  
    terra::tapp(
      stk, 
      index = times$season, 
      fun = "mean"
    ) %>% 
      magrittr::set_names(c("Winter", "Spring", "Summer", "Fall")) %>% 
      to_shp() %>% 
      tidyr::pivot_longer(
        -geometry,
        names_to = "season", 
        values_to = "value"
      ) %>% 
      dplyr::mutate(value = transform(value))
}
```

```{r table2.1}
# This is originally a table, probably will now be a figure
# TODO: Choose range of years.

f_list <- file.path(data_dir, "nexgddp_cmip6", "monthly") %>% 
  list.files(full.names = T, pattern = "tas") %>% 
  grep(".json", ., value = T, invert = T) %>% 
  grep("historical", ., value = T)

tmp <- terra::rast(f_list[[1]])
mt <- sf::st_transform(mt, crs = sf::st_crs(tmp))
transform <- function(x) (x - 273.15) * 1.8 + 32

tmin <- grep("tasmin.tif", f_list, value = T) %>% ensemble_average(transform = transform)
tmax <- grep("tasmax", f_list, value = T) %>% ensemble_average(transform = transform)
tavg <- grep("tas.tif", f_list, value = T) %>% ensemble_average(transform = transform)
```
```{r table2.2}
r <- file.path(data_dir, "nexgddp_cmip6", "monthly") %>% 
  list.files(full.names = T, pattern = "pr") %>% 
  grep(".json", ., value = T, invert = T) %>% 
  grep("historical", ., value = T) %>% 
  terra::rast()

days_in_mons <- lubridate::days_in_month(terra::time(r))
test <- purrr::map(1:length(days_in_mons), function(x) {
  print(x)
  tmp <- terra::subset(r, x)
  tmp * 24 * days_in_mons[x]
})
test <- function(x, y) {
  print(class(x))
  x
}


terra::app()
```
