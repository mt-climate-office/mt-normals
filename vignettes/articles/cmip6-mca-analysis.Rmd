---
title: "Rerunning the Montana Climate Assessment with CMIP6 Data"
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = nzchar(Sys.getenv("CMIP6_DIR"))
)
```

```{r setup}
library(magrittr)
library(terra)
library(sf)
library(ggplot2)

cmip_dir <- Sys.getenv("CMIP6_DIR")
gm_dir <- Sys.getenv("GRIDMET_DIR")

mt_state_plane <- 'PROJCS["NAD_1983_HARN_StatePlane_Montana_FIPS_2500 (deprecated)",
    GEOGCS["NAD83(HARN)",
        DATUM["NAD83_High_Accuracy_Reference_Network",
            SPHEROID["GRS 1980",6378137,298.257222101,
                AUTHORITY["EPSG","7019"]],
            AUTHORITY["EPSG","6152"]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4152"]],
    PROJECTION["Lambert_Conformal_Conic_2SP"],
    PARAMETER["latitude_of_origin",44.25],
    PARAMETER["central_meridian",-109.5],
    PARAMETER["standard_parallel_1",45],
    PARAMETER["standard_parallel_2",49],
    PARAMETER["false_easting",600000],
    PARAMETER["false_northing",0],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["Easting",EAST],
    AXIS["Northing",NORTH],
    AUTHORITY["ESRI","102300"]]'

mt <- sf::read_sf("https://data.climate.umt.edu/mt-normals/fgb/states.fgb") %>% 
  dplyr::filter(state_abbv == "MT") %>% 
  sf::st_transform(mt_state_plane)

counties <- sf::read_sf(
  "https://data.climate.umt.edu/mt-normals/fgb/counties.fgb"
) %>%
  dplyr::filter(state_abbv == "MT") %>% 
  sf::st_transform(mt_state_plane)

climdiv <- sf::read_sf(
  "https://data.climate.umt.edu/mt-normals/fgb/climdiv.fgb"
) %>%
  dplyr::filter(ST_ABBRV == "MT") %>% 
  sf::st_transform(mt_state_plane)


reference_period <- c(1981, 2010)
mid_century <- c(2040, 2069)
end_century <- c(2070, 2099)
```

```{r to_shp} 
mco_mask <- function(rast, mask){
  raster::mask(rast,
               fasterize::fasterize(mask %>%
                                      sf::st_transform(raster::projection(rast)),
                                    raster::raster(rast))
  )
}

to_shp <- function(x, mt) {
  
  tmp <- x %>%
    terra::project(mt_state_plane) %>%
    # terra::mask(mt %>% terra::vect(), touches=F) %>%
    raster::stack() %>%
    # mco_mask(mask = mt) %>%
    spex::qm_rasterToPolygons(na.rm = T) %>%
    tidyr::pivot_longer(-geometry, names_to = "time") 
  
  mt_use <- sf::st_transform(mt, sf::st_crs(tmp)) %>% 
    dplyr::select(geometry)
  
  sf::st_intersection(tmp, mt_use) 
}
```

```{r plot_seasonal} 
plot_seasonal <- function(dat, mt) {
  
  sf::st_as_sf(dat) %>% 
  ggplot() + 
    geom_sf(aes(fill = value), color = NA) + 
    facet_wrap(~time) + 
    geom_sf(data = mt, fill = NA) + 
    theme_bw()
}

plot_timeseries <- function(dat) {
  dat %>%
    dplyr::mutate(
      variable = dplyr::recode(
        variable,
        "tas" = "Average Temperature",
        "tasmax" = "Avg. Max Temperature",
        "tasmin" = "Avg. Min Temperature",
        "pr" = "Total Precipitation"
      ), 
      year = as.numeric(year)
    ) %>%
    dplyr::filter(time != "Annual") %>% 
    dplyr::mutate(time = factor(time, levels = c("Winter", "Spring", "Summer", "Fall"))) %>% 
    ggplot(aes(x=year, y=value, color = variable)) + 
      geom_line() + 
      geom_smooth(method = "lm") +
      facet_wrap(~time, scales = "free_y") +
      theme_minimal() + 
      labs(x="", y = "Temperature (Â°F)", color="")
}
```

```{r summary_functions}
time_avg <- function(
    fs, reference_period, period="annual", fun="mean", transform = NULL
) {
  
  checkmate::assert_choice(period, c("annual", "seasonal", "monthly"))
  
  stk <- terra::rast(fs) %>% 
    terra::tapp(index="days", fun="mean")
  
  times <- tibble::tibble(
    date = names(stk) %>% 
      stringr::str_replace("X", "") %>% 
      lubridate::as_date()
  ) %>% 
    dplyr::mutate(
      season = dplyr::case_when(
        lubridate::month(date) %in% c(12, 1, 2) ~ "Winter", # 1=winter
        lubridate::month(date) %in% c(3, 4, 5) ~ "Spring", # 2=spring
        lubridate::month(date) %in% c(6, 7, 8) ~ "Summer", # 3=summer
        lubridate::month(date) %in% c(9, 10, 11) ~ "Fall" # 4=fall
      ), 
      idx = 1:dplyr::n(),
      month = lubridate::month(date)
    ) %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(
      year = ifelse(
        (season == "Winter") && (lubridate::month(date)) == 12, 
        lubridate::year(date) + 1,
        lubridate::year(date)
      )
    ) %>%
    dplyr::group_by(year, season) %>% 
    dplyr::mutate(
      yearly_grp = dplyr::cur_group_id(),
      group_count = dplyr::n()
    ) %>% 
    dplyr::filter(
      year %in% reference_period[1]:reference_period[2],
    ) %>% 
    dplyr::mutate(
      yearly_grp = glue::glue("{season} {year}")
    )
  
  if (nrow(times) == 0) {
    return(NULL)
  }


  if (period == "annual"){
    r_filtered <- terra::subset(stk, times$idx) 

    out <- terra::tapp(
      r_filtered, index = times$year, fun = fun
    )
  } else if (period == "seasonal") {
    
    time_tmp <- dplyr::filter(times, group_count == 3)
    r_filtered <- terra::subset(stk, time_tmp$idx) 

    out <- terra::tapp(
      r_filtered, index = time_tmp$yearly_grp, fun = fun
    )  
  } else {
    r_filtered <- terra::subset(stk, times$idx) 

    out <- r_filtered
  }
  
  if (!is.null(transform)) {
    return(transform(out))
  }
  return(out)
}

timeseries_to_summary <- function(r, period) {
  
  if (is.null(r)) {
    return(NULL)
  }
  checkmate::assert_choice(period, c("annual", "seasonal", "monthly"))
  
  meta <- tibble::tibble(name = names(r))
  
  if (period == "annual") {
    grp <- rep("Annual", terra::nlyr(r))
  } else if (period == "seasonal") {
    grp <- meta %>% 
      tidyr::separate(name, c("season", "year")) %>% 
      dplyr::mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall"))) %$%
      season
  } else {
    grp <- meta %>% 
      dplyr::transmute(
        date = lubridate::as_date(name, format="X%Y.%m.%d"),
        month = month.name[lubridate::month(date)]
      ) %$%
      month
  }
  
  terra::tapp(
    r, index = grp, fun = "mean"
  )
}

filter_files <- function(f_list, scenario, variable) {
  grep(".json", f_list, value = T, invert = T) %>% 
    grep(scenario, ., value = T) %>% 
    grep(variable, ., value = T)
}

get_global_summary <- function(r, fun = "mean") {
  
  terra::global(r, fun) %>%
    tibble::rownames_to_column() %>% 
    magrittr::set_names(c("time", "value")) %>% 
    tibble::as_tibble() 
}

trend_func <- function(ys, threshold = 0.05) {
  
  xs <- 1:length(ys)
  mod <- lm(ys ~ xs)
  coeffs <- coef(mod)
  
  meta <- summary(mod)
  if (meta$coefficients[,4][2] > threshold) {
    return(0)
  }
  coeffs[2]
}



tas_tsfm <- function(x) (x - 273.15) * 1.8 + 32
pr_tsfm <- function(x) x/25.4

```

```{r preprocess_cmip, warning=FALSE}
f_list <- file.path(cmip_dir, "nexgddp_cmip6", "monthly") %>% 
  list.files(full.names = T)

tas_tsfm <- function(x) (x - 273.15) * 1.8 + 32
pr_tsfm <- function(x) x/25.4

cmip_df <- tidyr::crossing(
  scenario = c("historical", "ssp126", "ssp245", "ssp370", "ssp585"),
  variable = c("tasmin.tif", "tasmax.tif", "tas.tif", "pr.tif"), 
  timescale = c("annual", "monthly", "seasonal"),
  reference_period = list(
    "record"=c(1950, 2014), 
    "reference_period"=reference_period, 
    "mid_century"=mid_century, 
    "end_century"=end_century)
) %>%
  dplyr::mutate(
    fun = ifelse(variable == "pr.tif", "sum", "mean"),
    tsfm = ifelse(variable == "pr.tif", list(pr_tsfm), list(tas_tsfm))
  ) %>% 
  dplyr::rowwise() %>%
  dplyr::mutate(
    fs = list(filter_files(f_list, scenario, variable)),
    r = list(time_avg(
      fs = fs, 
      reference_period = reference_period, 
      period = timescale,
      fun = fun,
      transform = tsfm
    )),
    r_summarized = list(
      timeseries_to_summary(r, period = timescale)
    )
  ) %>% 
  dplyr::filter(!is.null(r)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(period_name = names(.$reference_period)) %>% 
  # dplyr::select(scenario, variable, timescale, r, r_summarized, period_name) %>% 
  dplyr::mutate(variable = stringr::str_replace(variable, ".tif", ""))
```

```{r preprocess_gridmet, warning=FALSE}
tmmn <- "~/data/gridmet/montana/tmmn.tif"
tmmx <- "~/data/gridmet/montana/tmmx.tif"
pr <- "~/data/gridmet/montana/pr.tif"

tidyr::crossing(
  variable = c("tmmx", "tmmn", "pr"), 
  timescale = c("annual", "monthly", "seasonal"),
  reference_period = list(
    "record"=c(1979, 2020), 
    "reference_period"=c(1991, 2020)
  )
) %>%
  dplyr::mutate(
    fun = ifelse(variable == "pr", "sum", "mean"),
    tsfm = ifelse(variable == "pr", list(pr_tsfm), list(tas_tsfm)),
    f = dplyr::case_when(
      variable == "tmmx" ~ tmmx,
      variable == "tmmn" ~ tmmn,
      variable == "pr" ~ pr
    )
  )

test <- file.path(gm_dir, "raw") %>% 
  list.files(full.names = T, recursive=TRUE, pattern = ".nc") %>% 
  grep("tmmx|tmmn|pr", ., value = T) %>% 
  tibble::tibble(f = .) %>%
  dplyr::mutate(variable = basename(dirname(f))) %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise(f = list(f)) 


test %>% 
  dplyr::mutate(variable = basename(dirname(f))) %>% 
  dplyr::right_join(crossed, by="variable")

```

```{r table2.1}
rast_df %>% 
  dplyr::filter(
    timescale %in% c("annual", "seasonal"),
    period_name == "reference_period",
    stringr::str_detect(variable, "tas|pr")
  ) %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(dat = list(get_global_summary(r_summarized))) %>% 
  dplyr::select(variable, dat) %>% 
  tidyr::unnest(dat) %>% 
  dplyr::mutate(
    variable = dplyr::recode(
      variable,
      "tas" = "Average Temperature",
      "tasmax" = "Avg. Max Temperature",
      "tasmin" = "Avg. Min Temperature",
      "pr" = "Total Precipitation"
    ),
    value = round(value)
  ) %>%
  tidyr::pivot_wider(names_from = time, values_from = value) %>%
  dplyr::rename(" " = variable) %>% 
  knitr::kable(
    caption = "Table 1: Average temperatures (Â°F) and Precipitation (in) across Montana from 1981-2010."
  )
```

```{r fig2.1, message=FALSE, warning=FALSE}
plt <- rast_df %>% 
  dplyr::filter(
    timescale %in% c("seasonal"),
    period_name == "reference_period",
    stringr::str_detect(variable, "tas|pr")
  ) %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(dat = list(to_shp(r_summarized))) %>% 
  dplyr::select(variable, dat) %>%
  dplyr::group_split() %>%
  purrr::map(function(x) {
    x$dat[[1]] %>% 
      dplyr::mutate(variable = x$variable)
  }) %>% 
  dplyr::bind_rows() %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise(plt = list(plot_seasonal(dplyr::cur_data_all(), mt)))
```


```{r table2.3}
tmp <- rast_df %>% 
  dplyr::filter(
    timescale %in% c("annual", "seasonal"),
    period_name == "record",
    stringr::str_detect(variable, "tas")
  ) %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(dat = list(get_global_summary(r))) %>%
  dplyr::select(variable, dat) %>%
  tidyr::unnest(dat) %>% 
  dplyr::mutate(
    time = stringr::str_replace(time, "X", "Annual.")
  ) %>% 
  tidyr::separate(time, c("time", "year")) 

trends <- tmp %>%
  dplyr::group_by(variable, time) %>% 
  dplyr::arrange(year) %>% 
  dplyr::summarise(
    trend = trend_func(value),
    .groups = "drop"
  ) 

table_out <- trends %>%
  dplyr::mutate(
    variable = dplyr::recode(
      variable,
      "tas" = "Average Temperature",
      "tasmax" = "Avg. Max Temperature",
      "tasmin" = "Avg. Min Temperature",
    ),
    trend = round(trend, 3)
  ) %>% 
  tidyr::pivot_wider(names_from = time, values_from = trend) %>%
  dplyr::rename(" " = variable) %>% 
  knitr::kable(
    caption = "Table 1: Average temperatures (Â°F) and Precipitation (in) across Montana from 1981-2010."
  )
```

```{r fig2.3, message=FALSE, warning=FALSE}
trend_spatial <- function(r) {
  tibble::tibble(time=names(r)) %>% 
    dplyr::mutate(
      time = stringr::str_replace(time, "X", "Annual.")
    ) %>% 
    tidyr::separate(time, c("time", "year")) %$%
    terra::tapp(r, time, fun = trend_func) 
}

trend_plots <- rast_df %>% 
  dplyr::filter(
    timescale %in% c("seasonal", "annual"),
    period_name == "record",
    stringr::str_detect(variable, "pr|tas")
  ) %>% 
  dplyr::rowwise() %>%
  dplyr::mutate(
    trends = list(trend_spatial(r)),
    dat = list(to_shp(trends))
  ) %>% 
  dplyr::select(variable, timescale, dat) %>%
  dplyr::group_split() %>%
  purrr::map(function(x) {
    x$dat[[1]] %>% 
      dplyr::mutate(variable = x$variable)
  }) %>% 
  dplyr::bind_rows() %>%
  dplyr::mutate(seasonal = ifelse(time == "Annual", FALSE, TRUE)) %>%
  dplyr::group_by(seasonal, variable) %>% 
  dplyr::summarise(plt = list(plot_seasonal(dplyr::cur_data_all(), mt=mt)))

```

```{r change_maps, message=FALSE, warning=FALSE}



plot_difference <- function(dat) {
    sf::st_as_sf(dat) %>% 
    ggplot() + 
      geom_sf(aes(fill = value), color = NA) + 
      facet_wrap(~scenario) + 
      geom_sf(data = mt, fill = NA) + 
      theme_bw()
  
}

tmp <- rast_df %>% 
  dplyr::filter(timescale == "annual", period_name != "record") %>%
  dplyr::select(scenario, variable, r_summarized, period_name) %>% 
  tidyr::unite(scenario, scenario, period_name, sep = "-")

dat <- dplyr::left_join(
  dplyr::filter(tmp, stringr::str_detect(scenario, "historical")) %>% 
    dplyr::select(variable, reference=r_summarized),
  dplyr::filter(tmp, stringr::str_detect(scenario, "historical", negate = TRUE)) %>% 
    tidyr::pivot_wider(names_from = scenario, values_from = r_summarized),
  by="variable"
) %>% 
  tidyr::pivot_longer(dplyr::starts_with("ssp"), values_to = "future") %>%
  tidyr::separate(name, c("scenario", "period"), sep = "-") %>% 
  dplyr::rowwise() %>% 
  # TODO: t-test between future and reference to make sure mean is truly different.
  dplyr::mutate(
    diff = list(to_shp(future - reference, mt=mt))
  ) %>% 
  dplyr::select(variable, scenario, period, diff)  %>% 
  dplyr::rowwise() %>% 
  dplyr::group_split() %>%
  purrr::map(function(x) {
    x$diff[[1]] %>% 
      dplyr::mutate(
        variable = x$variable,
        scenario = x$scenario,
        period = x$period
      )
  }) %>% 
  dplyr::bind_rows() %>% 
  sf::st_as_sf()

change_plots <- dat %>% 
  dplyr::group_by(variable, period) %>% 
  dplyr::summarise(plt = list(plot_difference(dplyr::cur_data_all()))) 
```
