---
params: 
  location: "Montana"
  asset_dir: "./assets"
  attr_id: "Division"
  attr_name: "Climate Division"
  attr_plural: "Climate Divisions"
  
---

```{r setup, echo=FALSE}
library(magrittr)
library(ggplot2)

shp <- sf::read_sf(file.path(params$asset_dir, "agg_regions.geojson"))
mt <- normals::mt %>% 
  dplyr::mutate(state = "MT")

f_list <- RCurl::getURL(
  "https://data.climate.umt.edu/mca/cmip/",
  ftp.use.epsv = TRUE,
  dirlistonly = FALSE
) %>%
  XML::getHTMLLinks() %>%
  grep(".tif", ., value = T) %>%
  grep(".json", ., value = T, invert = T)

cmip_files_full <- file.path(
  "https://data.climate.umt.edu/mca/cmip",
  basename(f_list)
)

cmip_files <- list.files(params$asset_dir, pattern = ".rds", full.names = T)

climdiv_to_factor <- function(x) {
  factor(x, levels = c("Western", "Southwestern", "North Central", "Central", "South Central", "Northeastern", "Southeastern"))
}

tas_tsfm <- function(x) (x - 273.15) * 1.8 + 32
pr_tsfm <- function(x) x/25.4

```

# Future Projections
## Global Climate Modeling
Projecting future climate on a global scale requires modeling many intricate relationships between the land, ocean, and atmosphere. Many global climate and Earth system models exist, each varying in complexity, capabilities, and limitations.

Consider one of the simplest forms of a model used for future projections, a linear regression model (@fig-lm-example). With this model, researchers would plot a climate variable (e.g., temperature) over time, draw a best-fit, straight line through the data, and then extend the line into the future. That line, then, provides a means of projecting future conditions. Whether or not those projections are valid is a separate question. For example, the model may be based on false assumptions: the relationship may a) not be constant through time, b) not include outside influences such as human interventions (e.g., policy regulations), and c) not consider system feedbacks that might enhance or dampen the relationship being modeled.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-lm-example
#| fig-cap: "Example of fitting a linear model to data to predict future conditions."
x = 1981:2045
y = seq(30, 35, length.out = length(x)) + rnorm(length(x), 0, 1)

tibble::tibble(x = x, y = y) %>% 
  dplyr::mutate(
    future = ifelse(x > 2022, "Projected", "Observed")
  ) %>% 
  ggplot() + 
    geom_point(aes(x=x, y=y, color=future)) +
    geom_smooth(aes(x=x, y=y), method = "lm", se = FALSE, color="black") + 
    theme_minimal() + 
  geom_vline(aes(xintercept=2022)) + 
  labs(x="", y="", color="")
```

While the linear regression model provides an instructive visual aid for considering modeling, it is too simple for looking at climate changes, in which the interactions are complex and often nonlinear. For example, if temperatures rises, evaporation is expected to increase. At the same time, increasing temperatures increase the atmosphere’s capacity to hold water. Water is a greenhouse gas so more water in the atmosphere means the atmosphere can absorb more heat... thus driving more evaporation. What seemed a simple relationship has changed (possibly dramatically) because of this feedback between temperature, evaporation, and the water-holding capacity of the atmosphere. 

Linear models do not account for such nonlinear relationships. Instead, climate scientists account for nonlinearity through computer simulations that describe the physical and chemical interactions between the land, oceans, and atmosphere. These simulations, which project climate change into the future, are called general circulation models (GCMs; see sidebar)

::: {.callout-note icon=false}
### General Circulation Models {#gcm-callout}

General circulation models (GCMs) help us project future climate conditions. They are the most advanced tools currently available for simulating the response of the global climate system—including processes in the atmosphere, ocean, cryosphere, and land surface—to increasing greenhouse gas concentrations. 

GCMs depict the climate using a 3-D grid over the globe, typically having a horizontal resolution of between 250 and 600 km (160 and 370 miles), 10-20 vertical layers in the atmosphere and sometimes as many as 30 layers in the oceans. Their resolution is quite coarse. Thus, impacts at the scale of a region, for example for Montana, require downscaling the results from the global model to a finer spatial grid (discussed later) (text adapted from IPCC 2013b).
:::

Because of the complexities involved, climate scientists rarely rely on a single model, but instead use an ensemble (or suite) of models. Each model in an ensemble represents a single description of future climate based on specific initial conditions and assumptions. The use of multiple models helps scientists explore the variability of future projections (i.e., how certain are we about the projection) and incorporate the strengths, as well as uncertainties, of multiple approaches.

For the work of the Montana Climate Assessment, we employed an ensemble from the sixth iteration of the Coupled Model Intercomparison Project (CMIP5), which includes up to 42 GCMs depending on the experiment conducted (CMIP5 undated). The World Climate Research Program describes CMIP as “a standard experimental protocol for studying the output” of GCMs (CMIP undated). It provides a means of validating, comparing, documenting, and accessing diverse climate model results. The CMIP project dates back to 1995, with the fifth iteration (CMIP5) starting in 2008 and providing climate data for the latest IPCC Fifth Assessment Report (Stocker et al. 2013).

We employed 20 individual GCMs from the CMIP5 project for the Montana Climate Assessment ensemble, chosen because they provide daily outputs and a range of important climate variables.9 For this first Montana Climate Assessment, we are only using climate variables of temperature and precipitation (later assessment may evaluate other important variables such as wind and relative humidity).

The benefits of using CMIP5 data are that each model in the ensemble a) has been rigorously evaluated, and b) uses the same standard socioeconomic trajectories—known as Representative Concentration Pathways (RCPs)—to describe future greenhouse gas emissions. RCPs are future greenhouse gas concentration scenarios.

Four RCP scenarios are available in CMIP5: RCP2.6, RCP4.5, RCP6.0, and RCP8.5. The number after RCP represents the increase in radiative forcing in watts/m2 by the year 2100. Higher radiative forcing values are associated with larger amounts of trapped heat in the atmosphere due to increased greenhouse gas emissions (see sidebar). Simply stated, higher RCP values are typically associated with greater greenhouse gas emissions and therefore greater potential for climate change. Each RCP scenario makes different assumptions about future energy sources, population growth, economic activities, and technological advancements, as follows:

- RCP2.6.—The peak-and-decline scenario assumes greenhouse gas emissions peak between 2010-2020 and then decline by the end-of-century, leading to a radiative forcing of 2.6 watts/m2. It assumes greenhouse gas emissions are substantially reduced over time (Van Vuuren et al. 2011). 
- RCP4.5.—The stabilization scenario where technological advancements and strategies lead to a peak in greenhouse gas emissions at about 2040 followed by a decline (Clarke et al. 2007). We explore the RCP4.5 scenario in this assessment, and the United Nations Paris Agreement of 2016 curbs emissions at a level between RCP2.6 and RCP4.5.
- RCP6.0.—A second stabilization scenario, but in this pathway greenhouse gas emissions peak at 2080 and stabilization is not achieved until after 2100 (Fujino et al. 2006). 
- RCP8.5.—The business-as-usual emission scenario where greenhouse gas emissions increase throughout the 21st century (Riahi et al. 2007, 2009), based on the assumption that society is largely unsuccessful in curbing those emissions. We use the RCP8.5 scenario, in which greenhouse gases steadily rise, and note that this pathway best matches current trends. 

::: {.callout-note icon=false}
### Shared Socioeconomic Pathways {#ssp-callout}
**give overview of ssps**
:::

For the Montana Climate Assessment, we explore the RCP4.5 and RCP8.5 scenarios only. We do not include RCP6.0 or RCP2.6 in our assessment for several reasons. RCP6.0 overlaps with RCP4.5 in the first half of the century and provides intermediate values between RCP4.5 and RCP8.5 at the end of the century. Additionally, RCP2.6 is becoming less and less realistic as society continues with business as usual regarding greenhouse gas emissions. For the remainder of the chapter, we will regularly refer to RCP4.5 and RCP8.5 as the stabilization and business-as-usual emission scenarios, respectively. 

Due to their complexity and global extent, GCMs can be computationally intensive. Thus, scientists often make climate projections at coarse spatial resolution where each projected data point is an average value of a grid cell that measures hundreds of miles (kilometers) across. 

For areas where the terrain and land cover are relatively homogenous (e.g., an expanse of the Great Plains), such coarse grid cells may be adequate to capture important climate processes. But in areas with complex landscapes like Montana, data points so widely spaced are inadequate to reflect variability in terrain and vegetation and their influence on climate. A 100 mile (161 km) grid, for example, might not capture the climate effects of a small mountain range rising out of the eastern Montana plains or the climate differences between mountain summits and valleys in western Montana where temperature and precipitation vary greatly.

To capture such important terrain characteristics, scientist take the coarse-resolution output from a GCM and statistically attribute the results from those models to smaller regions at higher resolution (e.g., grid points at 1 mile rather than 100 mile apart). This process, called downscaling, more accurately represents climate across smaller, more complex landscapes, including Montana.

For this climate assessment, we used a statistical downscaling method called the Multivariate Adaptive Constructive Analogs.10 By using a downscaled dataset—rather than the original output from the ensemble of GCMs—we gained the ability to evaluate temperature and precipitation at relatively high resolution statewide before conveying the results at the climate division scale. Additionally, we were able to aggregate data points within each of Montana’s seven climate divisions (Figure 2-3), and look at Montana’s climate future in different geographic areas. Aggregating to the climate-division level minimizes the potential for false precision by reporting results at spatial scales that better represent underlying climate processes. 

The 20-downscaled GCMs in CMIP5 were evaluated at two future time periods: 1) mid century (2040–2069) and 2) end-of-century (2070–2099). Thirty-year averages of these future projections were then compared to a historical (1971–2000) 30-year average, which results in a projected difference, or change, from historical conditions. We make those projections using the stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios described previously (see sidebar). These future projections were then compared to the historical trends in Montana to reveal the major climate-associated changes that Montana is likely to experience in the future.

## Temperature Projections
Below we provide projections for various aspects of Montana’s future temperature based on our modeling analysis. These projections are for the stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios and for two periods: mid century (2040-2069) and end-of-century (2070-2099).

We discuss a subset of our modeling results here, including a) temperature projections reported by the median values of the 20 GCM ensemble and b) figures that include maps and graphs that represent the median value and distribution of values observed for temperature across the 20 GCMs. 

An ensemble minimum, maximum, and percent agreement are also provided parenthetically. The percent agreement represents the number of GCMs that project the same sign of change (i.e., positive or negative) as the median value. For example, if the median value is positive and 18 out of 20 models also project positive change, then the percent agreement would be 100 x 18/20 = 90%. This simple calculation helps convey the uncertainty in the projections. 

### Average Annual Temperatures
Average annual temperatures increase in the mid-century and end-of-century projections for both stabilization and business-as-usual emission scenarios (Figures 2-9, 2-10). In the mid-century projection, most of the state has increases of about 4.5°F (2.5°C) for the stabilization emission scenario and 6.0°F (3.3°C) for the business-as-usual emission scenario. For end-of-century, statewide temperature increases by about 5.6°F (3.1°C) for the stabilization emission scenario and 9.8°F (5.4 °C) for the business-as-usual emission scenario. Although small differences exist between climate divisions, the general magnitude of these changes is consistent across the state for both emission scenarios and both time periods.

- Mid-century projection specifics.—Average annual temperatures increase by mid century in both emission scenarios (Figures 2-9 and 2-10). In the stabilization emission scenario, most of the state is projected to have increases of about 4.5°F (2.5°C) (minimum: 2.7°F [1.5°C], maximum: 6.1°F [3.4°C], percent agreement: 100%). The business-as-usual emission scenario projects larger increases in temperature of about 6.0°F (3.3°C) (minimum: 4.0°F [2.2°C], maximum: 8.2°F [4.6°C], model agreement: 100%). While small discrepancies exist between climate divisions, in general the magnitude of these changes is consistent across the state in both emission scenarios.
- End-of-century projection specifics.—Average annual temperatures increase by about 5.6°F (3.1°C) (minimum: 3.6°F [2.0°C], maximum: 7.7°F [4.3°C], percent agreement: 100%) in the stabilization emission scenario and by about 9.8°F (5.4°C) (minimum: 6.6°F [3.7°C], maximum: 12.9°F [7.2°C], percent agreement: 100%) in the business-as-usual emission scenario (Figure 2-9).

```{r temp_box}
#| label: fig-tavg-box
#| fig-width: 10
#| fig-height: 7
#| fig-cap: "Graphs showing the minimum, maximum, and median temperature increases (°F) projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows mid-century (2040-2069) projections and the bottom row shows end-of-century (2070-2099) projections. The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is >=80% model agreement and a red outline means that there is <80% model agreement. In this case, all models indicated the direction of the temperature trend at an agreement of greater than 80%."


tmp_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "tas.rds"), 
    shp = shp, 
    attr_id = params$attr_id
) 

normals::make_boxplot_plot(
  tmp_box_data,
  "Temperature Change (°F)", 
  "Change in Mean Annual Temperature"
)
```

### Average Daiily Minimum and Maximum Temperatures
Average daily minimum and maximum temperatures increase in the mid-century and end-of-century projections for both stabilization and business-as-usual emission scenarios (Figure 2-10 shows output for annual average daily maximum temperature). The degree of change is similar to that found for the average annual temperatures. In end-of-century projections, summers have the largest increases in average temperature: 6.5°F (3.6°C) for the stabilization emission scenario, 11.8°F (6.6°C) for the business-as-usual emission scenario.

- Mid-century projection specifics.—Average daily minimum and maximum temperatures change in a manner similar to the average annual projected increases (again for both RCP scenarios).
- End-of-century projection specifics.—Average daily minimum and maximum temperatures increase by similar magnitudes to average annual daily temperatures for both emission scenarios. Summer months have the largest projected increase in average temperature. In the stabilization emission scenario, summer temperatures increase by 6.5°F (3.6°C) (minimum: 3.2°F [1.8°C], maximum: 9.1°F [5.1°C], percent agreement: 100%) and in the business-as-usual emission scenario, summer temperatures increase by about 11.8°F (6.6°C) (minimum: 8.0°F [4.4°C], maximum: 15.2°F [8.4°C], percent agreement: 100%).

```{r tmmx_map, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-tmmx-map
#| fig.width: 10
#| fig.height: 15
#| fig-cap: "The projected increase in annual average daily maximum temperature (°F) for each climate division in Montana for the periods 2049-2069 and 2070-2099 for (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."


tmmx_map_data <- normals::make_map_data(
    stringr::str_subset(cmip_files, "tasmax.rds"), 
    shp = shp, 
    proj = normals::mt_state_plane
) 

normals::apply_map_by_scenario(
  dat = tmmx_map_data,
  shp = shp,
  hot = TRUE,
  title = "Change in Annual Maximum Temperature (°F)"
)
```


### Average Monthly Temperatures
Average monthly temperatures are projected to increase across all climate divisions by mid century (2040-2069) and for both stabilization and business-as-usual emission scenarios (Figure 2-11). Average monthly temperatures in summer and winter generally show larger projected increases than those in spring and fall. In the business-as-usual emission scenario, August has the largest projected change across all climate divisions. 

```{r tavg_heatmap, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-tavg-heatmap
#| fig.width: 10
#| fig.height: 15
#| fig-cap: " The projected monthly increase in average temperature (°F) for each climate division in Montana in the mid-century projections (2040-2069) for the (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."

tavg_heat_data <- normals::make_heatmap_data(
    stringr::str_subset(cmip_files, "tas.rds"), 
    shp = shp, 
    attr_id = params$attr_id
) 

normals::apply_heatmap_by_scenario(
  dat = tavg_heat_data,
  hot = TRUE,
  title = "Monthly Change in Average Temperature (°F)"
)
```

### Number of Days Above 90°F (32°C)
The number of annual days where maximum temperatures are above 90°F (32°C) increases across all climate divisions in both mid-century and end-of-century projections and for both stabilization and business-as-usual emission scenarios (Figures 2-12, 2-13). Large differences in the magnitude of change exist, however, among the climate divisions. For example, in mid-century projections using the business-as-usual emission scenario, the northwestern part of the state shows increases of about 11 days with temperatures above 90°F (32°C), while the eastern parts of the state have increases of about 33 days. Similarly, in end-of-century projections based on the business-as-usual emission scenario, the northwestern part of the state shows an increase of about 34 days, while the eastern parts of the state have an increase of about 54 days above 90°F (32°C).

- Mid-century projection specifics.—The number of annual days at mid century where maximum temperatures are above 90°F (32°C) increases across all climate divisions and both emission scenarios (Figure 2-12, 2-13). Large differences in the magnitude of change exist, however, among the climate divisions. These differences are likely due, in part, to variability in moisture availability among the climate divisions and the energy it takes to evaporate this moisture (i.e., latent heat). In the stabilization emission scenario, the northwestern and north central climate divisions have increases of about 5.0 days (minimum: 1.5 days, maximum: 12.0 days, percent agreement: 100%); while the number of days in both eastern and south central climate divisions of the state increase by about 25.0 days (minimum: 6.0 days, maximum: 36.0 days, percent agreement: 100%). Similar spatial patterns exist for the business-as-usual emission scenario, but the magnitudes of change increase along with the ranges of the ensemble minimums and maximums. In the northwestern and north central climate divisions of the state, increases of about 11 days are projected (minimum: 1.5 days, maximum: 25.0 days, percent agreement: 100%); in the south central and both eastern climate divisions increases are projected to be about 33.0 days (minimum: 11 days, maximum: 44.0 days, percent agreement: 100%).
- End-of-century projection specifics.—The number of days where maximum temperatures exceed 90°F (32°C) by the end-of-century continues to increase across the state in both emission scenarios, with 100% model agreement. The spatial pattern in the end-of-century projection is similar to that of the mid-century one (Figures 2-12, 2-13). For the stabilization emission scenario, the number of days/yr exceeding 90°F (32°C) increases in the northwestern and north central regions by about 8.5 days (minimum: 1.7 days, maximum: 22.0 days, percent agreement: 100%), while in the southern and eastern parts of the state, it increases by about 29.0 days (minimum: 11.0 days, maximum: 43.0 days, percent agreement: 100%). For the business-as-usual emission scenario, the number of days exceeding 90°F (32°C) in the northwestern and north central parts of the state increases by about 34.0 days (minimum: 9.5 days, maximum: 58.0 days, percent agreement: 100%), while in the southern and eastern parts of the state, it increases by about 54.0 days (minimum: 26.0 days, maximum: 70.0 days, percent agreement: 100%). 

```{r abv90_map, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-90-map
#| fig.width: 10
#| fig.height: 15
#| fig-cap: "The projected increases in number of days above 90°F (32°C) for each climate division in Montana over two periods 2040-2069 and 2070-2099 for (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."

abv90_map_data <- normals::make_map_data(
    stringr::str_subset(cmip_files, "above90.rds"), 
    shp = shp, 
    proj = normals::mt_state_plane,
    fun = "sum"
) 

normals::apply_map_by_scenario(
  dat = abv90_map_data,
  hot = TRUE,
  shp = shp,
  title = "Change in Annual Number of Days Above 90°F"
)
```

```{r abv90_box, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-90-box
#| fig.width: 10
#| fig.height: 7
#| fig-cap: "Graphs showing the increase in the number of days per year above 90°F (32°C) projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows mid-century projections (2040-2069) and the bottom row shows end-of-century projections (2070-2099). The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is ≥80% model agreement and a red outline means that there is <80% model agreement. In this case, all models indicated the direction of the trend for days above 90°F (32°C) at an agreement of greater than 80%."

abv90_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "above90.rds"), 
    shp = shp, 
    attr_id = params$attr_id,
    fun = "sum"
) 

normals::make_boxplot_plot(
  dat = abv90_box_data,
  ylab = "Number of Days",
  title = "Change in Number of Days Above 90°F"
)
```

### Number of Days Where Minimum Temperatures are Above 32°F (0°C)
The number of days/yr where minimum temperatures exceed 32°F (0°C; i.e., frost-free days) also increases across all climate divisions in both mid- and end-of-century projections and for both stabilization and business-as-usual emission scenarios (Figures 2-14, 2-15). While varying considerably across the state, projected changes are substantial. For example, in the mid-century projections with the stabilization emission scenario, frost-free days increase by about 30 days in the western part of the state and by 23 days in the eastern part of the state. Similar patterns exist for end-of-century projections: in the business-as-usual emission scenario, frost-free days increase by about 70 days in the western part of the state and by about 55 days in the eastern part of the state. 

- Mid-century projection specifics.—The number of days/yr where minimum temperatures are above 32°F (0°C; i.e., frost-free days) increases across all climate divisions and both emission scenarios (Figures 2-14, 2-15). In the stabilization emission scenario, frost-free days increase by 30.0 days in the western part of the state (minimum: 9.0 days, maximum: 51.0 days, percent agreement: 100%) and by 23.0 days in the eastern part of the state (minimum: 10.0 days, maximum: 43.0 days, percent agreement: 100%). In the business-as-usual emission scenario, frost-free days increase by 41.0 days in the western part of the state (minimum: 17.0 days, maximum: 68.0 days, percent agreement: 100%) and by 32.0 days in the eastern part of the state (minimum: 15.0 days, maximum: 63.0 days, percent agreement: 100%).
- End-of-century projection specifics.—The number of days/yr where minimum temperatures are above 32°F (0°C; i.e., frost-free days) continues to increase in the end-of-century projections across all climate divisions and for both emission scenarios, with 100% model agreement. Again, similar spatial patterns exist between the mid-century and end-of-century projections (Figures 2-14, 2-15). In the stabilization emission scenario, frost-free days increase by 41.0 days in the western part of the state (minimum: 18.0 days, maximum: 66.0 days, percent agreement: 100%), and by 30.0 days in the eastern part of the state (minimum: 14.0 days, maximum: 60.0 days, percent agreement: 100%). In the business-as-usual emission scenario, frost-free days increase by 70.0 days in the western part of the state (minimum: 36.0 days, maximum: 110.0 days, percent agreement: 100%), and by 55.0 days in the eastern part of the state (minimum: 26.0 days, maximum: 100.0 days, percent agreement: 100%).

```{r ff_map, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-ff-map
#| fig.width: 10
#| fig.height: 15
#| fig-cap: "The projected change in the number of frost-free days for each climate division in Montana over two periods 2040-2069 and 2070-2099 for (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."

ff_map_data <- normals::make_map_data(
    stringr::str_subset(cmip_files, "freeze-free.rds"), 
    shp = shp, 
    proj = normals::mt_state_plane,
    fun = "sum"
) 

normals::apply_map_by_scenario(
  dat = ff_map_data,
  hot = TRUE,
  shp = shp,
  title = "Change in Number of Freeze Free Days"
)
```

```{r ff_box, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-ff-box
#| fig.width: 10
#| fig.height: 7
#| fig-cap: "Graphs showing the increases in frost-free days/yr projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows mid-century projections (2040-2069) and the bottom row shows end-of-century projections (2070-2099). The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is >=80% model agreement and a red outline means that there is <80% model agreement. In this case, all models indicated the direction of the trend of frost-free days at an agreement of greater than 80%."

ff_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "freeze-free.rds"), 
    shp = shp, 
    attr_id = params$attr_id,
    fun = "sum"
) 

normals::make_boxplot_plot(
  dat = ff_box_data,
  ylab = "Number of Days",
  title = "Change in Number of Freeze Free"
)
```

### Summary 
In general, there is high model agreement and low uncertainty that temperatures and associated temperature metrics will increase both by mid century and end-of-century. For both periods, annual and seasonal temperature averages, the number of days/yr with extreme heat, and the overall length of the growing season are projected to increase. Differences exist in projections for the stabilization and business-as-usual emission scenarios, with the former consistently showing lower magnitudes of change than the latter. Many of the trends and spatial patterns seen in the mid-century projections are extended and exacerbated in the end-of-century projections. The range of model outputs also increases for end-of-century projections, suggesting that the magnitude of change becomes more uncertain in the models further out in time.

Regardless of uncertainties, the GCMs show full agreement regarding the direction of change: temperatures will be increasing. 

## Precipitation Projections
Below we provide projections of Montana’s future precipitation based on our modeling efforts. Those projections are for the stabilization and business-as-usual emission scenarios and for two periods: mid century (2040-2069) and end-of-century (2070-2099).

We discuss a subset of our precipitation modeling results here, including a) precipitation projections reported by the median values of the 20 GCM ensemble and b) figures that include maps and graphs that represent the median value and distribution of values observed for precipitation across the 20 GCMs. Special consideration is required for interpretations of precipitation changes in Montana’s complex terrain. Precipitation increases drastically with elevation such as that found in northwest Montana. Here, median values do not characterize the potential for spatial variability that exists within these regions.

An ensemble minimum, maximum, and percent agreement are also provided parenthetically. As with our temperature analysis, the percent agreement concerning the precipitation trends is based on the number of GCMs that project the same sign of change (i.e., positive or negative) as the median value. For example, if the median value is positive and 18 out of 20 models also project positive change, then the percent agreement would be 100 x 18/20 = 90%. This simple calculation helps convey the uncertainty in the projections. For some variables both the absolute change and the percent change from historical is calculated. 

### Average Annual Precipitation
Average annual precipitation increases across the state in both mid-century and end-of-century projections for both emission scenarios (Figures 2-16, 2-17, 2-18). For the mid-century projection using the stabilization emission scenario, increases of about 1.3 inch/yr (3.3 cm/yr) occur in the northwestern and north central climate divisions and about 0.9 inch/yr (2.3 cm/yr) in the southwestern, central, and eastern climate divisions. For the business-as-usual emission scenario in the mid-century projection, average annual precipitation increases by about 2.0 inch/yr (5.1 cm/yr) in the western half of the state, and about 1.8 inch/yr (4.6 cm/yr) in the eastern half of the state. The GCMs used in the ensemble show large differences in their end-of-century projections, but there is high agreement in the positive direction of change. 

- Mid-century projection specifics.—Average annual precipitation increases by mid century across the state for both emission scenarios, with moderately high agreement among models (Figures 2-16, 2-17, 2-18). In the stabilization scenario, increases of about 1.3 inch/yr (3.3 cm/yr) and 5.0% (minimum: -0.5 inch/yr [-1.3 cm/yr], -1.1%; maximum: 3.2 inch/yr [8.1 cm/yr], 14.0%; percent agreement: 85%) are projected in the northwestern parts of the state. In the southern and eastern parts of the state, increases of about 0.9 inch/yr (2.3 cm/yr) and 6.5% are projected (minimum: -1.2 inch/yr [-3.0 cm/yr], -6.0%; maximum: 2.5 inch/yr [6.4 cm/yr], 18.0%; percent agreement: 85%). In the business-as-usual emission scenario, average annual precipitation increase by about 1.6 inch/yr (4.1 cm/yr) and 6.5% in the northwestern parts of the state (minimum: -0.2 inch/yr [-0.51 cm/yr], -1.0%; maximum: 4.4 inch/yr [11.2 cm/yr], 17.0%; percent agreement: 90%), and by about 1.2 inch/yr (3.0 cm/yr) and 10% in the southern and eastern parts of the state (minimum: -0.5 inch/yr [-1.3 cm/yr], -3.5%; maximum: 2.9 inch/yr [7.4 cm/yr], 22.0%; percent agreement: 85%).
- End-of-century projection specifics.—Average annual precipitation is projected to increase through the end-of-century for both emission scenarios (Figures 2-16, 2-17, 2-18). The GCMs used in the ensemble show large differences in their end-of-century projections, but there is high agreement in the positive direction of change. In the stabilization emission scenario, average annual precipitation increases in the northwestern climate division by about 2.2 inch/yr (5.6 cm/yr) and 7.3% (minimum: -1.2 inch/yr [-3.0 cm/yr], -4.5%; maximum: 3.6 inch/yr [9.1 cm/yr], 12.9%; percent agreement: 85%), and by about 1.1 inch/yr (2.8 cm/yr) and 8.0% in the two eastern climate divisions (minimum: -0.5 inch/yr [-1.3 cm/yr], -4.5%; maximum: 3.0 inch/yr [7.6 cm/yr], 18.0%; percent agreement: 85%). In the business-as-usual emission scenario, average annual precipitation is projected to increase by slightly more than in the stabilization emission scenario, although the range of model projections also increases. In the western half of the state, annual precipitation increases by about 2.0 inch/yr (5.1 cm/yr) and 10.0% (minimum: 0.4 inch/yr [1.0 cm/yr], 1.3%; maximum: 5.5 inch/yr [14.0 cm/yr], 28.0%; percent agreement: 100%), and in the eastern half of the state annual precipitation increases by about 1.8 inch/yr (4.6 cm/yr) and 14.0% (minimum: -0.2 inch/yr [-0.5 cm/yr], -1.0%; maximum: 3.6 inch/yr [9.1 cm/yr], 26.0%; percent agreement: 95%). 

```{r pr_map, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-pr-map
#| fig.width: 10
#| fig.height: 15
#| fig-cap: "The projected change in annual precipitation (inches) for each climate division in Montana over two periods 2040-2069 and 2070-2099 for (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."

pr_map_data <- normals::make_map_data(
    f = stringr::str_subset(cmip_files, "pr.rds"), 
    shp = shp, 
    proj = normals::mt_state_plane,
    fun = "sum"
) 

normals::apply_map_by_scenario(
  dat = pr_map_data,
  hot = TRUE,
  shp = shp,
  title = "Change in Total Annual Precipitation (in.)"
)
```

```{r pr_box, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-pr-box
#| fig.width: 10
#| fig.height: 7
#| fig-cap: "Graphs showing annual precipitation change (in inches) projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows mid-century projections (2040-2069) and the bottom row shows end-of-century projections (2070-2099). The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is >=80% model agreement and a red outline means that there is <80% model agreement. In this case, all models indicated the direction of the annual precipitation trend at an agreement of greater than 80%."

pr_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "pr.rds"), 
    shp = shp, 
    attr_id = params$attr_id,
    fun = "sum"
) 

normals::make_boxplot_plot(
  dat = pr_box_data,
  ylab = "Precipitation (in.)",
  title = "Change in Monthly Precipitation (in.)"
)
```
### Interannual Variability
Interannual variability (i.e., the amount precipitation changes from year to year) is also projected to increase slightly across the state by mid century and end-of-century for both emission scenarios (Figure 2-19). The increase could be attributed to wet years getting wetter, dry years getting drier, or some combination of both.

```{r iv_box, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-iv-box
#| fig.width: 10
#| fig.height: 7
#| fig-cap: "Graphs showing the interannual variability of precipitation projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows mid-century projections (2040-2069) and the bottom row shows for end-of-century projections (2070-2099). The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is ≥80% model agreement and a red outline means that there is <80% model agreement."

iv_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "iv.rds"), 
    shp = shp, 
    attr_id = params$attr_id,
    fun = "mean"
) 

normals::make_boxplot_plot(
  dat = iv_box_data,
  ylab = "Inches",
  title = "Change in Interannual Precipitation Variability (in.)"
)
```
### Monthly and Seasonal Change in Average Precipitation
While annual increases in precipitation are projected across the state with moderately high model agreement, the monthly and seasonal projections vary. In mid-century projections, winter, spring, and fall increase in monthly precipitation for both emission scenarios, with spring experiencing the largest increases (e.g., 0.4 inch/month [1.0 cm/month] for the business-as-usual emission scenario; Figure 2-23). Summers, however, are projected to decrease by about 0.1 inch/month (0.3 cm/month) in both emission scenarios (model agreement, however, is fairly low for these projections). For end-of-century projections, the same trends are seen for increasing precipitation in winter, spring, and fall and decreasing precipitation in summer. The magnitude of change is similar to that of mid-century projections. 

```{r pr_heatmap, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-pr-heatmap
#| fig.width: 10
#| fig.height: 15
#| fig-cap: "Projected monthly change in average precipitation (inches) for each climate division in Montana in the mid-century projections (2040-2069) for (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."

pr_heat_data <- normals::make_heatmap_data(
    stringr::str_subset(cmip_files, "pr.rds"), 
    shp = shp, 
    attr_id = params$attr_id
) 

normals::apply_heatmap_by_scenario(
  dat = pr_heat_data,
  hot = FALSE,
  title = "Monthly Change in Total Precipitation (in.)"
)
```

- Mid-century projection specifics.—Although annual precipitation increases across the state with moderately high model agreement, the monthly and seasonal projections vary somewhat. Winter, spring, and fall increase in monthly precipitation for both emission scenarios, with the largest increases in spring (Figure 2-20). For the stabilization emission scenario, spring months increase by about 0.2 inch/month (0.5 cm/month) (minimum: -0.1 inch/month [-0.3 cm/month], maximum: 0.8 inch/month [2.0 cm/month], percent agreement: 85%). In the business-as-usual emission scenario, spring months increase by 0.4 inch/month (1.0 cm/month) (minimum: 0.0 inch/month [0 cm/month], maximum: 1.0 inch/month [2.5 cm/month], percent agreement: 95%). Summer months, however, show decreasing precipitation for both scenarios, although model agreement is fairly low in the projections. For the both the stabilization and business-as-usual emission scenarios, summer precipitation decreases by -0.1 inch/month (-0.3 cm/month) (minimum: -0.4 inch/month [-1.0 cm/month], maximum: 0.5 inch/month [1.3 cm/month], percent agreement: 65%). 
- Mid-century projection specifics.—Although annual precipitation increases across the state with moderately high model agreement, the monthly and seasonal projections vary somewhat. Winter, spring, and fall increase in monthly precipitation for both emission scenarios, with the largest increases in spring (Figure 2-20). For the stabilization emission scenario, spring months increase by about 0.2 inch/month (0.5 cm/month) (minimum: -0.1 inch/month [-0.3 cm/month], maximum: 0.8 inch/month [2.0 cm/month], percent agreement: 85%). In the business-as-usual emission scenario, spring months increase by 0.4 inch/month (1.0 cm/month) (minimum: 0.0 inch/month [0 cm/month], maximum: 1.0 inch/month [2.5 cm/month], percent agreement: 95%). Summer months, however, show decreasing precipitation for both scenarios, although model agreement is fairly low in the projections. For the both the stabilization and business-as-usual emission scenarios, summer precipitation decreases by -0.1 inch/month (-0.3 cm/month) (minimum: -0.4 inch/month [-1.0 cm/month], maximum: 0.5 inch/month [1.3 cm/month], percent agreement: 65%). 

## Projected Changes in Consecutive Dry Days
To assess changes in the frequency of dry events, we determined the annual number of dry days (defined as days when precipitation is less than 0.01 inch [0.03 cm]), then calculated the maximum number of consecutive dry days/yr averaged over the 30-year periods of interest. In general, in both mid- and end-of-century projections, we found a modest increase statewide in consecutive dry days—generally less than 0.5 days—for both emission scenarios (Figures 2-22, 2-23). Low model agreement exists and the range of projections from the ensemble of GCMs is wide, both suggesting high uncertainty in these projections.

- Mid-century projection specifics.—In general, consecutive dry days show a modest increase (i.e., less than 0.5 days); however, model agreement is low (approximately 60%; where 50% would mean complete disagreement among models) in both emission scenarios. 
- End-of-century projection specifics.—In end-of-century projections, changes in consecutive dry days/yr remain positive, but the increase is small (generally less than 0.5 days) with low model agreement (approximate 60%). This result is consistent across both emission scenarios. The range of projections from the ensemble of models is wide; however, minimum and maximum values are projected to increase by about -2.5 days and 4.0 days, respectively. This large range, in addition to the low model agreement, suggests high uncertainty in these projections. 

```{r dd_map, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-dd-map
#| fig.width: 10
#| fig.height: 15
#| fig-cap: "The projected change in the number of consecutive dry days (<0.1 inch [0.3 cm] of precipitation) for each climate division in Montana over two periods 2040-2069 and 2070-2099 for (A) stabilization (RCP4.5) and (B) business-as-usual (RCP8.5) emission scenarios."

dd_map_data <- normals::make_map_data(
    f = stringr::str_subset(cmip_files, "con-dry.rds"), 
    shp = shp, 
    proj = normals::mt_state_plane,
    fun = "sum"
) 

normals::apply_map_by_scenario(
  dat = dd_map_data,
  hot = FALSE,
  shp = shp,
  title = 'Change in Number of Consecutive Dry Days (<0.1in")'
)
```

```{r dd_box, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-dd-box
#| fig.width: 10
#| fig.height: 7
#| fig-cap: "Graphs showing the number of consecutive dry days in a year projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows mid-century projections (2040-2069) and the bottom row shows end-of-century projections (2070-2099). The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is ≥80% model agreement and a red outline means that there is <80% model agreement. In the case of consecutive dry days, there was less than 80% agreement across the models for all climate divisions."

dd_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "con-dry.rds"), 
    shp = shp, 
    attr_id = params$attr_id,
    fun = "sum"
) 

normals::make_boxplot_plot(
  dat = dd_box_data,
  ylab = "Nunber of Days",
  title = 'Change in Number of Consecutive Dry Days (<0.1in")'
)
```

### Projected Change in Wet Days
To evaluate changes in wet events, we calculated the number of days/yr where precipitation is greater than 1.0 inch (2.5 cm) and average those values over the period of interest (Figures 2-24). 

- Mid-century projection specifics.—Very modest changes in the number of wet events (i.e., less than 0.5 days) is projected for both emission scenarios. This time, however, model agreement is high that these small changes will occur (approximately 90%).
- End-of-century projection specifics.—Very high model agreement (approximately 100%) exists that the number of days/yr with precipitation above 1.0 inch (2.5 cm) will increase, although the magnitude of change is still small (less than 1.0 day). The northwestern climate division is projected to have the largest changes in this metric for both emission scenarios, reaching almost a 1.0 day increase of over 1.0 inch (2.5 cm) of precipitation for the period from 2070 to 2099. The range of model output is higher in the business-as-usual emission scenario.

```{r wd_box, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-wd-box
#| fig.width: 10
#| fig.height: 7
#| fig-cap: "Graphs showing the increase in the number of wet days/yr projected for each climate division in both stabilization (RCP4.5) and business-as-usual (RCP8.5) emission scenarios. The top row shows projections for mid century (2040-2069) and the bottom row shows projections for end-of-century (2070-2099). The outline of each box is determined by model agreement on the sign of the change (positive or negative). A black outline means there is ≥80% model agreement and a red outline indicates <80% model agreement. Model agreement for the trend of wet days each year was greater than 80%, except for the northeastern climate division."

wd_box_data <- normals::make_boxplot_data(
    stringr::str_subset(cmip_files, "con-wet.rds"), 
    shp = shp, 
    attr_id = params$attr_id,
    fun = "sum"
) 

normals::make_boxplot_plot(
  dat = wd_box_data,
  ylab = "Nunber of Days",
  title = 'Change in Number of Consecutive Wet Days (>1 in")'
)
```
### Summary
In mid-century and end-of-century projections, average annual precipitation and variability increase across the state, as does winter, spring, and fall precipitation. Summers, however, show slight decreases in precipitation. The projections suggest little change in the annual frequency of dry and wet events, although there is high uncertainty in the case of wet events. Similar analysis using different metrics for the larger region surrounding Montana indicates an even larger potential (30%) for more days of extreme precipitation (NCA 2014). Overall, the differences in precipitation resulting from the different emission scenarios (i.e., stabilization versus business-as-usual) are small when compared to the impact of the emission scenarios on the temperature projections. Uncertainty in the projections generally increases the further out in time (i.e., in the end-of-century projections), as well as for the higher business-as-usual emission scenario.

